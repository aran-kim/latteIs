{{>layout/header}}

<nav class="codrops-demos">
    <a href="/">Home</a>
    <a class="current-demo" href="/mychatroom">Chatting</a>
    <a href="/search">Search</a>
    <a href="/board">Board</a>
    <a href="/info">Info</a>
</nav>
</header>

<form>
    <h2>{{chatroom.roomname}}</h2>
    <!-- 송신 메시지 작성하는 창 -->
    <input id="textMessage" class="textMessage" type="text">

    <!-- 송신 버튼 -->
    <input onclick="sendMessage()" value="Send" type="button">

    <!-- 종료 버튼 -->
    <input onclick="disconnect()" value="Disconnect" type="button">

</form>

<!-- 결과 메시지 보여주는 창 -->

<div id="msgArea" class="col">

    {{#saveMessage}}
        <br>
        {{^me}}
            <div class='col-6'>
                <div class='alert alert-warning'>
                    <b><tr>
                        <td>나</td>
                        <td>:</td>
                        <td>{{message}}</td>
                    </tr></b>
                </div></div>
        {{/me}}
        <div class='col-6'>
            <div class='alert alert-secondary'>
                <b><tr>
                    <td>{{User.username}}</td>
                    <td>:</td>
                    <td>{{message}}</td>
                </tr></b>
            </div></div>

    {{/saveMessage}}
</div>
<script type="text/javascript">

    const webSocket = new WebSocket("ws://"+location.host+"/ws/chat?id="+{{chatroom.id}});

    var messageTextArea = document.getElementById("messageTextArea");

    //웹 소켓이 연결되었을 때 호출되는 이벤트

    webSocket.onopen = function(message){

        var option = {
            messagetype : "ENTER",
            roomId : {{chatroom.id}},
            sender : "{{username}}",
            msg : '가 채팅방을 들어왔습니다.'
        }
        webSocket.send(JSON.stringify(option));
    };

    //웹 소켓이 닫혔을 때 호출되는 이벤트

    webSocket.onclose = function(message){
    };

    //웹 소켓이 에러가 났을 때 호출되는 이벤트

    webSocket.onerror = function(ev,message){
        alert(ev.data);
        messageTextArea.value += ev.data+"error...\n";
    };

    //웹 소켓에서 메시지가 날라왔을 때 호출되는 이벤트

    webSocket.onmessage = function(data) {
        var msg = data.data;
        var d = JSON.parse(msg);
        if (d.messagetype == "ENTER") {
            var str = "<div class='col-6'>";
            str += "<div class='alert alert-secondary'>";
            str += "<b>" + d.sender + "가 채팅방을 들어왔습니다." + "</b>";
            str += "</div></div>";
            $("#msgArea").append(str);
        } else if (d.messagetype == "TALK") {
            if (d.sender == "{{username}}") {
                var str = "<div class='col-6'>";
                str += "<div class='alert alert-secondary'>";
                str += "<b>나 :" +d.msg + "</b>";
                str += "</div></div>";
                $("#msgArea").append(str);

            } else {
                var str = "<div class='col-6'>";
                str += "<div class='alert alert-warning'>";
                str += "<b>" + d.sender + " :" +d.msg + "</b>";
                str += "</div></div>";
                $("#msgArea").append(str);            }
        } else if (d.messagetype == "EXIT") {
            var str = "<div class='col-6'>";
            str += "<div class='alert alert-secondary'>";
            str += "<b>" + d.sender + "가 채팅방을 나갔습니다." + "</b>";
            str += "</div></div>";
            $("#msgArea").append(str);        }
    };



    //Send 버튼을 누르면 실행되는 함수
    function sendMessage(){
        var message = document.getElementById("textMessage");
        var option = {
            messagetype : "TALK",
            roomId : {{chatroom.id}},
            sender : "{{username}}",
            msg : $("#textMessage").val()
        }
        webSocket.send(JSON.stringify(option));
        message.value = "";
    }

    //웹소켓 종료
    function disconnect(){
        var option = {
            messagetype : "EXIT",
            roomId : {{chatroom.id}},
            sender : "{{username}}",
            msg :'가 채팅방을 나갔습니다.'
        }
        webSocket.send(JSON.stringify(option));
        webSocket.close();
        location.href = "/exitchatroom?id="+"{{chatroom.id}}";
    }

</script>


{{>layout/footer}}